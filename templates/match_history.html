<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Match History</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .servant-thumbnail {
            width: 64px;
            height: 64px;
            border-radius: 3px;
            margin-right: 1rem;
            vertical-align: middle;
            object-fit: cover;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container">
                <a class="navbar-brand" href="#">Fate Another</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                    aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav">
                        <li class="nav-item">
                            <a class="nav-link" href="/">Score Board</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" href="match_history">Match History</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="room_status.html">Room Status</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container mt-4">
        <div id="match-history-container">
        </div>

        <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Page navigation">
                <ul class="pagination">
                    <li class="page-item"><a class="page-link" href="#" id="prev-page">Previous</a></li>
                    <li class="page-item disabled"><a class="page-link" href="#">Page <span id="current-page">1</span>
                            of <span id="total-pages">1</span></a></li>
                    <li class="page-item"><a class="page-link" href="#" id="next-page">Next</a></li>
                </ul>
            </nav>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
<script>
    const matchContainer = document.querySelector('#match-history-container');
    const currentPageSpan = document.querySelector('#current-page');
    const totalPagesSpan = document.querySelector('#total-pages');
    const prevLink = document.querySelector('#prev-page');
    const nextLink = document.querySelector('#next-page');

    const limit = 10;
    let offset = 0;
    let totalItems = 0;

    function fetchMatches() {
        fetch(`/api/match_histories?limit=${limit}&offset=${offset}`)
            .then(response => response.json())
            .then(data => {
                totalItems = data.total;
                updateMatches(data);
                updatePagination(data);
            })
            .catch(error => console.error('Error fetching match history:', error));
    }

    function updateMatches(data) {
        matchContainer.innerHTML = '';
        data.data.forEach(match => {
            const teamA = match.teams ? match.teams.find(team => team.index === 1) : null;
            const teamB = match.teams ? match.teams.find(team => team.index === 2) : null;

            const teamAName = teamA ? teamA.name : 'N/A';
            const teamAScore = teamA ? teamA.score : 'N/A';
            const teamBName = teamB ? teamB.name : 'N/A';
            const teamBScore = teamB ? teamB.score : 'N/A';

            const mapName = match.map.split('\\').pop();

            const teamADetails = teamA ? createTeamTable(teamA.servants, teamAName, teamAScore) : '<p>No servants</p>';
            const teamBDetails = teamB ? createTeamTable(teamB.servants, teamBName, teamBScore) : '<p>No servants</p>';

            const card = document.createElement('div');
            card.className = 'card mb-3';

            card.innerHTML = `
                    <div class="card-header">
                        <h5 class="card-title mb-0">Match ID: ${match.id}</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text"><strong>Map:</strong> ${mapName}</p>
                        <p class="card-text"><strong>DateTime:</strong> ${formatDateTime(match.datetime)}</p>
                        <p class="card-text"><strong>Duration:</strong> ${formatDuration(match.duration)}</p>
                        <div class="row g-3">
                            <div class="col-md-6">
                                ${teamADetails}
                            </div>
                            <div class="col-md-6">
                                ${teamBDetails}
                            </div>
                        </div>
                    </div>
                `;
            matchContainer.appendChild(card);
        });
    }

    function createTeamTable(servants, teamName, score) {
        if (!servants || servants.length === 0) return `<p>No servants for ${teamName} (Score: ${score})</p>`;

        let table = `
                <table class="table table-sm table-bordered align-middle">
                    <thead>
                        <tr>
                            <th colspan="4" class="text-center bg-light">${teamName} (Score: ${score})</th>
                        </tr>
                        <tr>
                            <th>User</th>
                            <th>Servant</th>
                            <th>Level</th>
                            <th>KDA</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
        servants.forEach(servant => {
            table += `
                    <tr>
                        <td>${servant.UserName}</td>
                        <td><img src="${getServantImgUrl(servant.Name)}" alt="${servant.Name}" onerror="fallbackImg(this)" class="servant-thumbnail">${servant.Name}</td>
                        <td>${servant.Level}</td>
                        <td>${servant.Kills}/${servant.Deaths}/${servant.Assists}</td>
                    </tr>
                `;
        });
        table += '</tbody></table>';
        return table;
    }

    function updatePagination(data) {
        const totalPages = Math.ceil(totalItems / limit);
        const currentPage = Math.floor(offset / limit) + 1;
        currentPageSpan.textContent = currentPage;
        totalPagesSpan.textContent = totalPages;

        prevLink.parentElement.classList.toggle('disabled', offset === 0);
        nextLink.parentElement.classList.toggle('disabled', offset + limit >= totalItems);
    }

    function formatDateTime(isoString) {
        const date = new Date(isoString);
        return date.toLocaleString();
    }

    function formatDuration(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes}m ${remainingSeconds}s`;
    }

    fetchMatches();

    prevLink.addEventListener('click', (event) => {
        event.preventDefault();
        if (offset > 0) {
            offset -= limit;
            fetchMatches();
        }
    });

    nextLink.addEventListener('click', (event) => {
        event.preventDefault();
        if (offset + limit < totalItems) {
            offset += limit;
            fetchMatches();
        }
    });
</script>
<script>
    const servantImageUrls = {
        "Gilles de Rais": "Gilles.jpg",
        "Cu Chulainn": "CuChulainn.jpg",
        "SasakiKojirou": "Sasaki.jpg",
        "Artoria.Alter": "ArtoriaAlter.jpg",
        "Jack the Ripper": "Jack.jpg",
        "Li Shuwen": "Lee.jpg",
        "Vlad III": "Vlad.jpg",
        "Nursery Rhymes": "Nursery.jpg",
        "Avenger (F/HA)": "Angra.jpg",
        "Caster": "Tamamo.jpg",
        "Erzsébet": "Elizabeth.jpg",
        "Scáthach": "Scatach.jpg",
        "ScÃ¡thach": "Scatach.jpg",
        "Angra Mainyu": "Angra.jpg",
        "HassanKing": "KingHassan.jpg",
        "Frankenstein": "Frank.jpg",
        "Ryougi Shiki": "Ryougi.jpg",
        "Avenger": "Edmond.jpg",
    };

    const baseUrl = "/assets/img/";
    function getServantImgUrl(name) {
        const fileName = servantImageUrls[name] || `${name}.jpg`;
        const fullUrl = baseUrl + fileName;
        return fullUrl
    }

    function fallbackImg(img) {
        img.onerror = null;
        img.src = "https://placehold.co/64";
    }
</script>

</html>